<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2048 Neon</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        body { background: #05050a; color: #fff; font-family: 'Orbitron', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; user-select: none; }
        
        #score-board { font-size: 2.5rem; font-weight: bold; margin-bottom: 20px; color: #FFD700; text-shadow: 0 0 10px #FFD700; }
        
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #222; padding: 10px; border-radius: 10px; width: 300px; height: 300px; box-sizing: border-box; }
        
        .cell { width: 100%; height: 100%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; border-radius: 5px; color: #000; transition: transform 0.2s; }
        
        /* Neon Colors */
        .val-0 { background: #333; }
        .val-2 { background: #00f2ea; color: #000; box-shadow: 0 0 5px #00f2ea; }
        .val-4 { background: #bf00ff; color: #fff; box-shadow: 0 0 10px #bf00ff; }
        .val-8 { background: #ff0055; color: #fff; box-shadow: 0 0 15px #ff0055; }
        .val-16 { background: #FFD700; color: #000; box-shadow: 0 0 20px #FFD700; }
        .val-32 { background: #fff; color: #000; box-shadow: 0 0 25px #fff; }
        .val-64 { background: #00ff00; color: #000; box-shadow: 0 0 30px #00ff00; }
        
        .back { position: absolute; top: 20px; left: 20px; font-size: 2rem; cursor: pointer; color: #fff; }
        
        #game-over { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); flex-direction:column; align-items:center; justify-content:center; }
        button { margin-top:20px; padding:10px 20px; font-size:1.2rem; background:#FFD700; border:none; border-radius:20px; cursor:pointer; font-family: 'Orbitron'; font-weight:900; }
    </style>
</head>
<body>
    <div class="back" onclick="window.parent.postMessage('close_game','*')">âœ•</div>
    <div id="score-board">0</div>
    <div class="grid" id="grid"></div>
    <div style="margin-top:20px; color:#aaa; font-size:0.8rem;">SWIPE TO COMBINE</div>

    <div id="game-over">
        <h1 style="color:#ff0055">GRID LOCKED</h1>
        <button onclick="init()">RESTART</button>
    </div>

    <script>
        let board = Array(16).fill(0);
        let score = 0;
        const gridEl = document.getElementById('grid');

        function init() {
            document.getElementById('game-over').style.display = 'none';
            board = Array(16).fill(0);
            score = 0;
            spawn(); spawn();
            draw();
        }

        function spawn() {
            let empty = board.map((v, i) => v === 0 ? i : null).filter(v => v !== null);
            if(empty.length === 0) return false;
            let idx = empty[Math.floor(Math.random() * empty.length)];
            board[idx] = Math.random() > 0.9 ? 4 : 2;
            return true;
        }

        function draw() {
            gridEl.innerHTML = '';
            board.forEach(val => {
                let d = document.createElement('div');
                d.className = 'cell val-' + val;
                d.innerText = val > 0 ? val : '';
                gridEl.appendChild(d);
            });
            document.getElementById('score-board').innerText = score;
        }

        // SWIPE LOGIC
        let touchStartX = 0, touchStartY = 0;
        window.addEventListener('touchstart', e => { touchStartX=e.changedTouches[0].screenX; touchStartY=e.changedTouches[0].screenY; }, {passive:false});
        window.addEventListener('touchmove', e => { e.preventDefault(); }, {passive:false}); // Prevent scroll
        window.addEventListener('touchend', e => {
            let dx = e.changedTouches[0].screenX - touchStartX;
            let dy = e.changedTouches[0].screenY - touchStartY;
            if(Math.abs(dx) > Math.abs(dy)) {
                if(Math.abs(dx) > 30) { if(dx > 0) moveRight(); else moveLeft(); }
            } else {
                if(Math.abs(dy) > 30) { if(dy > 0) moveDown(); else moveUp(); }
            }
        });

        // GAME LOGIC (Simplified 1D array manipulation)
        function operate(row) {
            row = row.filter(x => x); // Remove zeros
            for(let i=0; i<row.length-1; i++) {
                if(row[i] === row[i+1]) {
                    row[i] *= 2;
                    score += row[i];
                    row[i+1] = 0;
                }
            }
            row = row.filter(x => x); // Remove zeros again
            while(row.length < 4) row.push(0);
            return row;
        }

        function moveLeft() {
            let oldBoard = [...board];
            for(let i=0; i<4; i++) {
                let row = [board[i*4], board[i*4+1], board[i*4+2], board[i*4+3]];
                let newRow = operate(row);
                for(let k=0; k<4; k++) board[i*4+k] = newRow[k];
            }
            finalizeMove(oldBoard);
        }

        function moveRight() {
            let oldBoard = [...board];
            for(let i=0; i<4; i++) {
                let row = [board[i*4+3], board[i*4+2], board[i*4+1], board[i*4]];
                let newRow = operate(row);
                for(let k=0; k<4; k++) board[i*4+(3-k)] = newRow[k];
            }
            finalizeMove(oldBoard);
        }

        function moveUp() {
            let oldBoard = [...board];
            for(let i=0; i<4; i++) {
                let col = [board[i], board[i+4], board[i+8], board[i+12]];
                let newCol = operate(col);
                for(let k=0; k<4; k++) board[i+k*4] = newCol[k];
            }
            finalizeMove(oldBoard);
        }

        function moveDown() {
            let oldBoard = [...board];
            for(let i=0; i<4; i++) {
                let col = [board[i+12], board[i+8], board[i+4], board[i]];
                let newCol = operate(col);
                for(let k=0; k<4; k++) board[i+(3-k)*4] = newCol[k];
            }
            finalizeMove(oldBoard);
        }

        function finalizeMove(oldBoard) {
            if(JSON.stringify(oldBoard) !== JSON.stringify(board)) {
                spawn();
                draw();
                // Send Score Live
                window.parent.postMessage({ type: 'game_over', game: '2048', score: score }, '*');
            } else {
                // Check Full
                if(!board.includes(0)) document.getElementById('game-over').style.display = 'flex';
            }
        }

        init();
    </script>
</body>
</html>
