<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>Cosmic Glide 3D</title>  
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Poppins:wght@400;600&display=swap" rel="stylesheet">  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>  
    <style>  
        body { margin: 0; overflow: hidden; background: #05050a; font-family: 'Orbitron', sans-serif; color: white; touch-action: none; user-select: none; }
        #game-glider { width: 100vw; height: 100vh; position: relative; }
        
        /* HUD */
        #glider-hud-layer { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; box-sizing: border-box; pointer-events: none; z-index: 10; display:flex; justify-content:space-between; }
        .score-box { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); font-size: 1.2rem; }
        .dust-session { color: #FFD700; font-size: 1.2rem; text-shadow: 0 0 10px #FFD700; }

        /* Overlays */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,10,0.9); z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 15px 40px; border-radius: 30px; font-family: 'Orbitron'; font-size: 1.2rem; margin-top: 20px; cursor: pointer; transition:0.2s; }
        .btn:active { transform:scale(0.95); background: rgba(255,255,255,0.3); }
        
        .exit-btn { pointer-events: auto; background: rgba(255,0,0,0.2); border: 1px solid red; padding: 5px 15px; border-radius: 10px; color: white; cursor: pointer; font-size: 0.8rem; }

        /* NOTIFICATIONS */
        #msg-area { position: absolute; top: 20%; width: 100%; text-align: center; pointer-events: none; z-index: 15; }
        .game-msg { font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 20px currentColor; animation: popUp 1.5s forwards; }
        @keyframes popUp { 0%{transform:scale(0); opacity:0;} 20%{transform:scale(1.2); opacity:1;} 80%{opacity:1;} 100%{transform:translateY(-50px); opacity:0;} }
    </style>
</head>  
<body>  

<div id="game-glider">  
    <div id="glider-hud-layer">  
        <div class="score-box">SCORE: <span id="score-val">0</span></div> 
        <div class="dust-session">✨ <span id="dust-val">0</span></div>
        <button class="exit-btn" onclick="exitGame()">EXIT</button> 
    </div>  
    <div id="msg-area"></div>
    <div style="position: absolute; bottom: 30px; width: 100%; text-align: center; color: rgba(255,255,255,0.5); pointer-events: none; z-index:5;">DRAG TO FLY</div>
</div>  

<div id="start-overlay" class="overlay">
    <h1 id="game-title" style="color:#ff00ff; text-shadow:0 0 20px #ff00ff; font-size:2.5rem; text-align: center;">COSMIC GLIDE</h1>
    <p id="skin-label" style="color:#aaa; font-size:0.9rem; margin-top:-10px;">DEFAULT SYSTEM</p>
    <button class="btn" onclick="initGlider()">START FLIGHT</button>
</div>

<div id="game-over" class="overlay" style="display:none;">
    <h2 style="color:#ff4757; font-size:3rem;">CRASHED</h2>
    <div id="score-final" style="font-size: 4rem; color: #fff;">0</div>
    <div style="color:#FFD700; margin-top:10px;">COLLECTED: <span id="final-dust">0</span> ✨</div>
    <button class="btn" onclick="location.reload()">RETRY</button>
    <button class="btn" style="background:transparent; border:none;" onclick="exitGame()">EXIT</button>
</div>

<script>
    let gScene, gCam, gRen, gPlayer, gGrid;
    let gObstacles=[], gStars=[], gStardust=[]; 
    let gFrameId, isPlay=false;
    let gSpeed=0.5, score=0, dustSession=0;

    const urlParams = new URLSearchParams(window.location.search);
    const currentSkin = urlParams.get('skin') || 'default';

    const skinConfig = {
        default: { color: 0x00f2ea, bg: 0x05050a, grid: 0x00f2ea, title: "COSMIC GLIDE", geo: 'cone' },
        gold: { color: 0xFFD700, bg: 0x1a1100, grid: 0xFFD700, title: "GOLDEN VOYAGE", geo: 'ship' },
        neon: { color: 0xff00ff, bg: 0x1a001a, grid: 0xff00ff, title: "NEON GLITCH", geo: 'box' }
    };
    const activeStyle = skinConfig[currentSkin] || skinConfig.default;

    document.getElementById('game-title').innerText = activeStyle.title;
    document.getElementById('game-title').style.color = '#' + activeStyle.color.toString(16);
    document.getElementById('skin-label').innerText = currentSkin.toUpperCase() + " EDITION";

    function exitGame() { window.parent.postMessage('close_game', '*'); }

    function showMsg(text, color) {
        const area = document.getElementById('msg-area');
        const d = document.createElement('div');
        d.className = 'game-msg';
        d.innerText = text;
        d.style.color = color;
        area.appendChild(d);
        setTimeout(() => d.remove(), 1500);
    }

    function initGlider() {
        document.getElementById('start-overlay').style.display = 'none';
        isPlay = true;
        
        gScene = new THREE.Scene();
        gScene.fog = new THREE.FogExp2(activeStyle.bg, 0.04);
        gScene.background = new THREE.Color(activeStyle.bg);
        gCam = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 100);
        gRen = new THREE.WebGLRenderer({antialias:true});
        gRen.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('game-glider').appendChild(gRen.domElement);
        
        gScene.add(new THREE.AmbientLight(0x404040, 2));
        const dl = new THREE.DirectionalLight(0xffffff, 1); dl.position.set(0,10,5); gScene.add(dl);
        gGrid = new THREE.GridHelper(200, 40, activeStyle.grid, 0x222222); gScene.add(gGrid);

        let geo, mat;
        mat = new THREE.MeshPhongMaterial({ color: activeStyle.color, emissive: 0x111111, shininess: 100 });

        if(activeStyle.geo === 'cone') {
            gPlayer = new THREE.Mesh(new THREE.ConeGeometry(0.5, 1.5, 8), mat);
            gPlayer.rotation.x = Math.PI/2;
        } else if(activeStyle.geo === 'ship') {
            const group = new THREE.Group();
            group.add(new THREE.Mesh(new THREE.TetrahedronGeometry(0.8), mat));
            const wing = new THREE.Mesh(new THREE.BoxGeometry(2, 0.1, 0.5), mat); wing.position.set(0,0,0.2);
            group.add(wing); gPlayer = group; gPlayer.rotation.x = -0.2;
        } else {
            mat.wireframe = true; gPlayer = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), mat);
        }

        gPlayer.position.set(0,1,-2); gScene.add(gPlayer);

        if(window.innerWidth < 600) { gCam.position.set(0, 5, 12); gCam.rotation.x = -0.4; } 
        else { gCam.position.set(0, 3, 8); gCam.rotation.x = -0.3; }

        document.addEventListener('mousemove', gMove);
        document.addEventListener('touchmove', gTouch, {passive:false});
        
        gliderLoop();
    }

    function gMove(e) {
        if(!isPlay || !gPlayer) return;
        const limit = window.innerWidth < 600 ? 5 : 8;
        const x = (e.clientX/window.innerWidth)*2-1;
        gPlayer.position.x = x * limit;
        if(gPlayer.rotation) gPlayer.rotation.z = -x * 0.5;
        else if(gPlayer.children) gPlayer.rotation.z = -x * 0.5; 
    }
    function gTouch(e) { e.preventDefault(); gMove(e.touches[0]); }

    function gliderLoop() {
        if(!isPlay) return;

        // Obstacles
        if(Math.random() < 0.03) {
            const obs = new THREE.Mesh(new THREE.BoxGeometry(1.5,1.5,1.5), new THREE.MeshPhongMaterial({color:0xff4757}));
            obs.position.set((Math.random()*16)-8, 1, -50); gScene.add(obs); gObstacles.push(obs);
        }
        // Score Stars
        if(Math.random() < 0.05) {
            const star = new THREE.Mesh(new THREE.OctahedronGeometry(0.3), new THREE.MeshBasicMaterial({color:0xffffff}));
            star.position.set((Math.random()*16)-8, 1.5, -50); gScene.add(star); gStars.push(star);
        }
        // STARDUST (FARMING) - Increased rate for purchasing system
        if(Math.random() < 0.01) { // 1% chance per frame (roughly every 2s)
            const dust = new THREE.Mesh(new THREE.DodecahedronGeometry(0.6), new THREE.MeshBasicMaterial({color: 0xFFD700, wireframe: true}));
            dust.position.set((Math.random()*14)-7, 2, -60);
            gScene.add(dust); gStardust.push(dust);
        }

        const pBox = new THREE.Box3().setFromObject(gPlayer);

        // Move/Check
        for(let i=gObstacles.length-1; i>=0; i--) {
            let o = gObstacles[i]; o.position.z += gSpeed;
            if(new THREE.Box3().setFromObject(o).intersectsBox(pBox)) { gameOver(); return; }
            if(o.position.z > 10) { gScene.remove(o); gObstacles.splice(i,1); }
        }
        for(let i=gStars.length-1; i>=0; i--) {
            let s = gStars[i]; s.position.z += gSpeed; s.rotation.y += 0.1;
            if(s.position.distanceTo(gPlayer.position) < 2) {
                gScene.remove(s); gStars.splice(i,1); score += 50;
            } else if(s.position.z > 10) { gScene.remove(s); gStars.splice(i,1); }
        }
        for(let i=gStardust.length-1; i>=0; i--) {
            let d = gStardust[i]; d.position.z += gSpeed; d.rotation.x += 0.05;
            if(d.position.distanceTo(gPlayer.position) < 2.5) {
                gScene.remove(d); gStardust.splice(i,1);
                dustSession++;
                document.getElementById('dust-val').innerText = dustSession;
                showMsg("+1 ✨", "#FFD700");
                window.parent.postMessage({type: 'stardust_collected'}, '*');
            } else if(d.position.z > 10) { gScene.remove(d); gStardust.splice(i,1); }
        }

        if(currentSkin === 'neon' && gPlayer) gPlayer.rotation.x += (Math.random()-0.5)*0.1;

        gSpeed += 0.0005; score += 0.5;
        document.getElementById('score-val').innerText = Math.floor(score);
        gRen.render(gScene, gCam);
        gFrameId = requestAnimationFrame(gliderLoop);
    }

    function gameOver() {
        isPlay = false;
        document.getElementById('game-over').style.display = 'flex';
        document.getElementById('score-final').innerText = Math.floor(score);
        document.getElementById('final-dust').innerText = dustSession;
        
        let scores = JSON.parse(localStorage.getItem('brainArcadeV6') || '{}');
        if(!scores.glider || Math.floor(score) > scores.glider) {
            scores.glider = Math.floor(score);
            localStorage.setItem('brainArcadeV6', JSON.stringify(scores));
        }
    }

    window.addEventListener('resize', () => {
        if(!gCam || !gRen) return;
        gCam.aspect = window.innerWidth / window.innerHeight;
        gCam.updateProjectionMatrix();
        gRen.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
