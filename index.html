<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">  
    <title>Brain Arcade v6: Galaxy Edition</title>  
    <link rel="icon" type="image/png" href="./icon194.png">  
    <link rel="apple-touch-icon" href="./icon512.png">  

    <link rel="preconnect" href="https://fonts.googleapis.com">  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>  
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Poppins:wght@400;600&display=swap" rel="stylesheet">  
    <link rel="manifest" href="manifest.json">  

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>  

<style>  
    /* --- CORE THEME --- */  
    :root {  
        --bg-dark: #05050a;  
        --cyan: #00f2ea;  
        --blue: #4facfe;  
        --pink: #ff0080;  
        --purple: #bf00ff;  
        --green: #00e676;  
        --red: #ff4757;  
        --yellow: #f1c40f;  
        --font-head: 'Orbitron', sans-serif;  
        --font-body: 'Poppins', sans-serif;  
    }  
      
    body {  
        margin: 0; font-family: var(--font-body);  
        background-color: var(--bg-dark);  
        color: #fff;   
        overflow: hidden;   
        overscroll-behavior-y: contain;   
        touch-action: none;   
        user-select: none;  
        -webkit-tap-highlight-color: transparent;  
        height: 100vh;
        height: 100dvh; 
    }  

    /* --- BACKGROUND --- */  
    .nebula-bg {  
        position: fixed; top: 0; left: 0; width: 100vw; height: 100%; z-index: -2;  
        background: radial-gradient(circle at 50% 50%, #1a0b2e, #05050a 80%);  
        animation: nebulaPulse 10s infinite alternate;  
    }  
    @keyframes nebulaPulse {  
        0% { background: radial-gradient(circle at 50% 50%, #1a0b2e, #05050a 80%); }  
        100% { background: radial-gradient(circle at 50% 50%, #0b1a2e, #05050a 85%); }  
    }  
      
    .star-field {  
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;  
        background-image:   
            radial-gradient(1px 1px at 10% 10%, white, transparent),  
            radial-gradient(2px 2px at 40% 40%, rgba(255,255,255,0.8), transparent),  
            radial-gradient(1px 1px at 80% 60%, white, transparent);  
        background-size: 300px 300px;  
        opacity: 0.6;  
        animation: drift 60s linear infinite;  
    }  
    @keyframes drift { from { background-position: 0 0; } to { background-position: 0 300px; } }  

    /* --- ANIMATIONS --- */  
    @keyframes shake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-5px, 5px); } 75% { transform: translate(-5px, -5px); } }  
    .shaking { animation: shake 0.4s; }  
    @keyframes float { 0% {transform:translateY(0px);} 50% {transform:translateY(-10px);} 100% {transform:translateY(0px);} }  
    .float-anim { animation: float 3s ease-in-out infinite; }  

    /* --- UI LAYOUT --- */  
    #app { 
        width: 100vw; 
        height: 100vh; 
        height: 100dvh; 
        position: relative; 
        display: flex; 
        flex-direction: column; 
    }  
      
    .screen {  
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;  
        display: flex; flex-direction: column; align-items: center; justify-content: center;  
        opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out;  
        padding: 20px; box-sizing: border-box; z-index: 5;  
    }  
    .active { opacity: 1; pointer-events: auto; }  

    h1 {   
        font-family: var(--font-head); font-size: 2.8rem; margin-bottom: 5px; text-align: center;   
        background: linear-gradient(to right, var(--cyan), var(--purple));   
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;   
        text-shadow: 0px 0px 30px rgba(191, 0, 255, 0.5); letter-spacing: 2px; margin-top: 0;
    }  

    /* --- SUGGESTED APPS HEADER --- */
    .suggest-bar {
        display: flex;
        gap: 15px;
        justify-content: center;
        width: 100%;
        margin-top: 20px;
        margin-bottom: 10px;
        z-index: 20;
    }
    .suggest-btn {
        display: flex;
        flex-direction: column; /* Icon top, text bottom */
        align-items: center;
        text-decoration: none;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 10px 15px;
        border-radius: 15px;
        backdrop-filter: blur(5px);
        transition: transform 0.2s, background 0.2s;
        cursor: pointer;
        min-width: 80px;
    }
    .suggest-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.15); }
    .suggest-btn img {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        margin-bottom: 5px;
        object-fit: cover;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .suggest-btn span {
        font-size: 0.65rem;
        color: var(--cyan);
        font-family: var(--font-head);
        letter-spacing: 1px;
        text-transform: uppercase;
        text-align: center;
    }

    /* --- MENU --- */  
    .menu-scroll {   
        width: 100%; flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center;   
        padding-bottom: 80px; 
        -webkit-overflow-scrolling: touch;  
        touch-action: pan-y;   
    }  
    .menu-grid {   
        display: grid; grid-template-columns: repeat(auto-fit, minmax(135px, 1fr));   
        gap: 15px; width: 100%; max-width: 500px; padding: 10px; box-sizing: border-box;  
    }  
    .game-card {  
        background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);  
        padding: 15px; border-radius: 16px; text-align: center; cursor: pointer;   
        transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.4); backdrop-filter: blur(5px);  
        position: relative; overflow: hidden;  
    }  
    .game-card:active { transform: scale(0.96); background: rgba(255,255,255,0.12); }  
    .game-card h3 { margin: 0; font-size: 0.9rem; color: var(--cyan); font-family: var(--font-head); letter-spacing: 1px; }  
    .game-card .hs-label { font-size: 0.6rem; color: #aaa; margin-top: 8px; display: block; font-weight: bold; letter-spacing: 1px; }  
    .game-card .hs-val { color: #fff; font-size: 1.1rem; font-weight: bold; font-family: var(--font-head); text-shadow: 0 0 10px rgba(255,255,255,0.3); }  

    /* --- HUD & CONTROLS --- */  
    #hud {  
        position: absolute; top: 0; width: 100%; height: 70px; display: none; justify-content: space-between; align-items: center;   
        padding: 0 25px; box-sizing: border-box; z-index: 10; font-family: var(--font-head);  
        background: linear-gradient(180deg, rgba(5,5,10,0.95) 0%, transparent 100%);  
    }  
    #score-display { font-size: 1.5rem; color: #fff; text-shadow: 0 0 15px var(--blue); }  
    .btn-small { background: rgba(255,255,255,0.1); padding: 8px 18px; border-radius: 20px; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.15); color:white; font-family: var(--font-head); backdrop-filter: blur(4px); cursor: pointer; }  
    .btn-small:active { background: rgba(255,255,255,0.25); }  

    .timer-bar-bg { width: 100%; max-width: 400px; height: 6px; background: rgba(255,255,255,0.08); border-radius: 3px; overflow: hidden; margin-bottom: 25px; }  
    .timer-bar-fill { width: 100%; height: 100%; background: var(--cyan); transition: width 0.05s linear; box-shadow: 0 0 15px var(--cyan); border-radius: 3px; }  

    /* --- GAME SPECIFIC STYLES --- */  
    #grid-container { display: grid; gap: 10px; margin-top: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); }  
    .tile { width: 65px; height: 65px; background: rgba(255,255,255,0.08); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); transition: transform 0.1s; }  
    .tile.lit { background: var(--cyan); box-shadow: 0 0 30px var(--cyan); border-color: white; transform: scale(1.15); z-index: 2; }  
      
    #math-problem { font-size: 4.5rem; font-family: var(--font-head); margin: 30px 0; text-shadow: 0 0 25px rgba(255,255,255,0.2); }  
    .math-options { display: flex; gap: 20px; width: 100%; max-width: 400px; }  
    .math-btn { flex: 1; font-size: 2.2rem; border-radius: 18px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: white; padding: 25px; font-family: var(--font-head); backdrop-filter: blur(5px); }  
      
    #color-word { font-size: 4.5rem; font-family: var(--font-head); margin-bottom: 40px; text-shadow: 0 0 30px rgba(0,0,0,0.8); font-weight: 900; }  
    .color-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 360px; }  
    .color-btn { height: 75px; font-size: 1.2rem; border-radius: 14px; border: none; font-weight: bold; color:white; font-family: var(--font-head); }  
      
    .grid-game { display: grid; gap: 8px; width: 100%; max-width: 380px; aspect-ratio: 1; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 20px; }  
    .odd-tile { background: rgba(255,255,255,0.08); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-family: var(--font-head); cursor: pointer; }  
      
    #order-container { position: relative; width: 95%; height: 55vh; background: rgba(255,255,255,0.03); border-radius: 25px; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; }  
    .order-bubble { position: absolute; width: 55px; height: 55px; background: linear-gradient(135deg, var(--blue), #00c6ff); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: var(--font-head); font-weight: bold; font-size: 1.5rem; box-shadow: 0 0 20px rgba(79, 172, 254, 0.4); animation: pulse 0.5s ease-out; cursor: pointer; }  
    @keyframes pulse { 0% {transform:scale(0);} 80% {transform:scale(1.1);} 100% {transform:scale(1);} }  

    #dash-arrow { font-size: 9rem; filter: drop-shadow(0 0 15px currentColor); display: inline-block; }  
    .dpad { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; width: 260px; }  
    .dpad-btn { width: 75px; height: 75px; background: rgba(0, 242, 234, 0.05); border-radius: 12px; border: 1px solid rgba(0, 242, 234, 0.3); font-size: 2.2rem; color: var(--cyan); display: flex; align-items: center; justify-content: center; cursor: pointer; }  
    .dpad-up { grid-column: 2; } .dpad-left { grid-column: 1; grid-row: 2; } .dpad-down { grid-column: 2; grid-row: 2; } .dpad-right { grid-column: 3; grid-row: 2; }  

    .reflex-tile { background: rgba(255, 0, 128, 0.1); border-radius: 12px; border: 1px solid rgba(255, 0, 128, 0.2); transition: 0.05s; }  
    .reflex-tile.active-target { background: var(--pink); box-shadow: 0 0 40px var(--pink), inset 0 0 10px white; transform: scale(1.05); border: 2px solid white; z-index: 10; }  

    #runner-container { width: 95%; max-width: 700px; display: flex; flex-direction: column; align-items: center; }  
    canvas#runner-canvas { background: rgba(0, 0, 0, 0.3); border: 3px solid var(--purple); border-radius: 16px; box-shadow: 0 0 25px rgba(191, 0, 255, 0.4); width: 100%; height: auto; image-rendering: pixelated; }  

    /* --- 3D COSMIC GLIDER STYLES --- */  
    #game-glider { padding: 0; overflow: hidden; }  
    #glider-canvas-area { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }  
    #glider-hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; padding: 20px; }  
    .dust-counter { font-family: var(--font-head); font-size: 1.2rem; color: #ffd700; text-shadow: 0 0 10px #ffaa00; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; display: inline-block; border: 1px solid #ffd700; }  
      
    /* Egg / Reward Modal Styles */  
    #egg-overlay {   
        position: absolute; top:0; left:0; width:100%; height:100%; z-index: 60;  
        background: rgba(5,5,10,0.95); backdrop-filter: blur(15px);  
        display:none; flex-direction:column; justify-content:center; align-items:center; text-align: center;  
    }  
    .egg-display { font-size: 5rem; animation: float-anim 3s infinite ease-in-out; margin: 20px 0; display:block; }  
    .reward-info { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); width: 80%; max-width: 300px; margin-bottom: 20px; }  

    /* --- OVERLAYS --- */  
    #msg-overlay {   
        position: absolute; top:0; left:0; width:100%; height:100%; z-index: 50;  
        background: rgba(5, 5, 10, 0.95); backdrop-filter: blur(15px);  
        display:none; flex-direction:column; justify-content:center; align-items:center;   
    }  
    #countdown-overlay {  
        position: absolute; top:0; left:0; width:100%; height:100%; z-index: 40;  
        background: rgba(5, 5, 10, 0.7); backdrop-filter: blur(8px);  
        display:none; justify-content:center; align-items:center;   
        pointer-events: none;  
    }  
    #countdown-text { font-family: var(--font-head); font-size: 10rem; color: var(--cyan); text-shadow: 0 0 50px var(--cyan); animation: float-anim 1s infinite; }  
      
    .particle { position: absolute; width: 8px; height: 8px; border-radius: 50%; pointer-events: none; }  

    /* --- INSTALL POPUP --- */  
    #install-popup {  
        position: fixed; bottom: -200px; left: 50%; transform: translateX(-50%);  
        width: 90%; max-width: 400px;  
        background: rgba(5, 5, 10, 0.95);  
        border: 1px solid var(--cyan);  
        border-radius: 20px 20px 0 0;  
        padding: 25px;  
        z-index: 1000;  
        text-align: center;  
        box-shadow: 0 0 30px rgba(0, 242, 234, 0.2);  
        backdrop-filter: blur(10px);  
        transition: bottom 0.4s;  
        display: none;   
    }  
    #install-popup.show { bottom: 0; display: block; }  
      
    #btn-install-action {  
        background: var(--green); color: #000; border: none; padding: 12px 30px; border-radius: 25px;  
        font-weight: bold; font-family: var(--font-head); box-shadow: 0 0 15px var(--green); cursor: pointer;  
        font-size: 1rem; width: 100%; margin-bottom: 10px;  
    }  
</style>

</head>  
<body>  
<div id="app">  
    <div class="nebula-bg"></div>  
    <div class="star-field"></div>  
    <div id="particles" style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 100; overflow:hidden;"></div>  
    
    <div id="hud">  
        <span id="score-display">SCORE: 0</span>  
        <button class="btn-small" onclick="showMenu()">EXIT</button>  
    </div>  

    <div id="menu" class="screen active">  
        
        <div class="suggest-bar float-anim">
            <a href="https://twolife-v1.github.io/my/" target="_blank" class="suggest-btn">
                <img src="./icon-512.png" alt="Solat Icon">
                <span>‚¨áÔ∏è WaktuSolatLite app</span>
            </a>
            <a href="https://pipahcookiesapp.github.io/com/" target="_blank" class="suggest-btn">
                <img src="./icon.png" alt="Cookies Icon">
                <span>‚¨áÔ∏è PipahCookies app</span>
            </a>
        </div>
        <div style="padding: 10px 0;">  
            <h1>BRAIN<br>ARCADE</h1>  
            <p style="text-align:center; opacity: 0.6; font-size: 0.9rem; margin: 0; letter-spacing: 3px; color:var(--cyan);">GALAXY EDITION</p>  
        </div>  
        <div class="menu-scroll">  
            <div class="menu-grid">  
                <div class="game-card" onclick="startSequence('glider')" style="border-top: 3px solid #ff00ff; box-shadow: 0 0 20px rgba(255,0,255,0.3); grid-column: span 2;">  
                    <h3 style="color:#ff00ff; font-size: 1.2rem;">COSMIC GLIDE 3D</h3>  
                    <span class="hs-label">HIGH SCORE</span><span id="hs-glider" class="hs-val">0</span>  
                    <div id="menu-egg-timer" style="font-size:0.8rem; color:#ffd700; margin-top:5px; display:none;">ü•ö HATCHING...</div>  
                </div>  

                <div class="game-card" onclick="startSequence('memory')" style="border-top: 3px solid var(--blue);">  
                    <h3>MEMORY MATRIX</h3>  
                    <span class="hs-label">BEST</span><span id="hs-memory" class="hs-val">0</span>  
                </div>  
                <div class="game-card" onclick="startSequence('math')" style="border-top: 3px solid var(--purple);">  
                    <h3>QUICK MATH</h3>  
                    <span class="hs-label">BEST</span><span id="hs-math" class="hs-val">0</span>  
                </div>  
                <div class="game-card" onclick="startSequence('color')" style="border-top: 3px solid var(--yellow);">  
                    <h3>COLOR TRAP</h3>  
                    <span class="hs-label">BEST</span><span id="hs-color" class="hs-val">0</span>  
                </div>  
                <div class="game-card" onclick="startSequence('odd')" style="border-top: 3px solid #fff;">  
                    <h3>ODD ONE OUT</h3>  
                    <span class="hs-label">BEST</span><span id="hs-odd" class="hs-val">0</span>  
                </div>  
                <div class="game-card" onclick="startSequence('order')" style="border-top: 3px solid var(--blue);">  
                    <h3>ORDER CHAOS</h3>  
                    <span class="hs-label">BEST</span><span id="hs-order" class="hs-val">0</span>  
                </div>  
                <div class="game-card" onclick="startSequence('dash')" style="border-top: 3px solid var(--green);">  
                    <h3 style="color:var(--green)">DIRECTION DASH</h3>  
                    <span class="hs-label">BEST</span><span id="hs-dash" class="hs-val">0</span>  
                </div>  
                <div class="game-card" onclick="startSequence('reflex')" style="border-top: 3px solid var(--pink);">  
                    <h3 style="color:var(--pink)">RAPID REFLEX</h3>  
                    <span class="hs-label">BEST</span><span id="hs-reflex" class="hs-val">0</span>  
                </div>  
                <div class="game-card" onclick="startSequence('runner')" style="border-top: 3px solid var(--purple);">  
                    <h3 style="color:var(--purple)">ROCKET RUN</h3>  
                    <span class="hs-label">BEST</span><span id="hs-runner" class="hs-val">0</span>  
                </div>  
            </div>  
        </div>  
    </div>  

    <div id="countdown-overlay"><div id="countdown-text">3</div></div>  

    <div id="game-memory" class="screen"><h2 id="level-display" style="color:var(--cyan); font-size:2rem; text-shadow:0 0 10px var(--cyan);">LEVEL 1</h2><div id="grid-container"></div></div>  

    <div id="game-math" class="screen">  
        <div class="timer-bar-bg"><div id="math-timer" class="timer-bar-fill" style="background:var(--purple); box-shadow:0 0 15px var(--purple);"></div></div>  
        <div id="math-problem"></div>  
        <div class="math-options"><button id="btn-opt1" class="math-btn" onclick="ansMath(true, event)"></button><button id="btn-opt2" class="math-btn" onclick="ansMath(false, event)"></button></div>  
    </div>  

    <div id="game-color" class="screen">  
        <div class="timer-bar-bg"><div id="color-timer" class="timer-bar-fill" style="background:var(--yellow); box-shadow:0 0 15px var(--yellow);"></div></div>  
        <div style="font-size: 1.1rem; margin-bottom: 20px; text-align:center; color:#aaa;">Match the <b>TEXT COLOR</b></div>  
        <div id="color-word">WORD</div>  
        <div class="color-controls" id="color-grid"></div>  
    </div>  

    <div id="game-odd" class="screen"><div class="timer-bar-bg"><div id="odd-timer" class="timer-bar-fill" style="background:#fff; box-shadow:0 0 15px white;"></div></div><div id="odd-grid" class="grid-game"></div></div>  

    <div id="game-order" class="screen">  
        <div class="timer-bar-bg"><div id="order-timer" class="timer-bar-fill" style="background:var(--blue); box-shadow:0 0 15px var(--blue);"></div></div>  
        <h3>TAP: <span id="next-num" style="color:var(--cyan); font-size:2.5rem; text-shadow:0 0 20px var(--cyan);">1</span></h3>  
        <div id="order-container"></div>  
    </div>  

    <div id="game-dash" class="screen">  
        <div class="timer-bar-bg"><div id="dash-timer" class="timer-bar-fill" style="background:var(--green); box-shadow:0 0 15px var(--green);"></div></div>  
        <div style="text-align:center; margin-bottom:10px; font-size:1rem; color:#ccc; letter-spacing:1px; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:10px;"><span style="color:var(--green)">GREEN = Follow</span> &nbsp;|&nbsp; <span style="color:var(--red)">RED = Opposite</span></div>  
        <div id="dash-arrow-container" class="float-anim"><div id="dash-arrow">‚¨Ü</div></div>  
        <div class="dpad">  
            <div class="dpad-btn dpad-up" onclick="checkDash('U', event)">‚¨Ü</div>  
            <div class="dpad-btn dpad-left" onclick="checkDash('L', event)">‚¨Ö</div>  
            <div class="dpad-btn dpad-down" onclick="checkDash('D', event)">‚¨á</div>  
            <div class="dpad-btn dpad-right" onclick="checkDash('R', event)">‚û°</div>  
        </div>  
    </div>  

    <div id="game-reflex" class="screen">  
        <div class="timer-bar-bg"><div id="reflex-timer" class="timer-bar-fill" style="background:var(--pink); box-shadow:0 0 15px var(--pink);"></div></div>  
        <h3 style="color:var(--pink); font-size:2rem; text-shadow:0 0 20px var(--pink); letter-spacing:2px;">TAP LIGHT</h3>  
        <div id="reflex-grid" class="grid-game" style="grid-template-columns: repeat(3, 1fr);"></div>  
    </div>  

    <div id="game-runner" class="screen">  
        <h3 style="color:var(--purple); font-size:2rem; text-shadow:0 0 20px var(--purple); letter-spacing:2px; margin-bottom: 25px;">ROCKET RUN</h3>  
        <div id="runner-container">  
            <canvas id="runner-canvas" width="700" height="300"></canvas>  
            <div style="color:#aaa; font-size:0.8rem; margin-top:10px;">Tap to Jump</div>  
        </div>  
        <button class="btn-small" style="background:var(--purple); color:white; font-size:1.1rem; padding:15px 40px; border:none; margin-top:20px;" onclick="runnerJump(event)">BOOST!</button>  
    </div>  

    <div id="game-glider" class="screen">  
        <div id="glider-hud-layer">  
            <div class="dust-counter">‚≠ê <span id="glider-dust-val">0</span></div>  
            <div style="position: absolute; bottom: 30px; width: 100%; text-align: center; color: rgba(255,255,255,0.5); pointer-events: none;">DRAG TO FLY</div>  
        </div>  
        <div id="glider-canvas-area"></div>  
    </div>  

    <div id="msg-overlay">  
        <h2 style="color: var(--red); font-size: 3.5rem; margin:0; text-shadow: 0 0 30px var(--red);">GAME OVER</h2>  
        <p id="msg-reason" style="margin-top:0; opacity:0.8; font-size:1.2rem; font-family:var(--font-head); color:#fff;">...</p>  
          
        <div id="egg-ui" style="display:none; background: rgba(0,0,0,0.5); padding:15px; border-radius:15px; border:1px solid #ffd700; margin:10px 0;">  
            <div style="color:#ffd700; font-family:var(--font-head);">MYSTERY EGG AVAILABLE!</div>  
            <div style="font-size:0.9rem; color:#ccc; margin:5px 0;">Cost: 10 Stars</div>  
            <button class="btn-small" id="btn-hatch" style="background:#ffd700; color:#000; font-weight:bold; box-shadow:0 0 15px #ffd700;">START INCUBATION (30m)</button>  
        </div>  

        <div style="background: rgba(255,255,255,0.05); padding: 15px 50px; border-radius: 20px; margin: 20px 0; border:1px solid rgba(255,255,255,0.1); backdrop-filter:blur(5px);">  
            <div style="font-size:0.9rem; opacity:0.6; letter-spacing:2px;">SCORE</div>  
            <div id="final-score" style="font-size: 4rem; font-family: var(--font-head); color: var(--cyan); text-shadow:0 0 20px var(--cyan);">0</div>  
        </div>  
        <button class="btn-small" style="font-size:1.3rem; padding:18px 50px; background:var(--cyan); color:#000; border:none; box-shadow:0 0 25px var(--cyan);" onclick="restartGame()">RETRY</button>  
        <button class="btn-small" onclick="showMenu()" style="margin-top:25px; border:none; background:transparent; font-size:1rem; opacity:0.7;">BACK TO MENU</button>  
    </div>  

    <div id="egg-overlay">  
        <h2 style="color: #ffd700; font-size: 3rem; text-shadow: 0 0 20px #ffaa00; margin:0;">EGG HATCHED!</h2>  
        <span class="egg-display">üõ∏</span>  
        <div class="reward-info">  
            <h3 id="reward-name" style="color:var(--cyan); margin:0; font-size:1.5rem;">NEW SHIP!</h3>  
            <p>You have unlocked a new Ship Style.</p>  
        </div>  
        <button class="btn-small" onclick="claimReward()" style="background:#00e676; color:#000; font-size:1.2rem; padding:15px 40px;">EQUIP & CLOSE</button>  
    </div>  

    <div id="install-popup">  
        <h3>INSTALL APP</h3>  
        <div id="install-text">Install Brain Arcade for the best experience!</div>  
        <button id="btn-install-action" style="display:block;">INSTALL NOW</button>  
        <span class="close-link" onclick="closeInstallPopup()" style="font-size:0.8rem; color:#aaa; text-decoration:underline; cursor:pointer;">Not now, maybe later</span>  
    </div>

</div>  
<script>  
    // --- AUDIO SYSTEM ---  
    const Audio = {  
        ctx: null,  
        init: function() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); if(this.ctx.state==='suspended') this.ctx.resume(); },  
        play: function(freq, type, dur, vol=0.1) {  
            if(!this.ctx) return;  
            const o=this.ctx.createOscillator(), g=this.ctx.createGain();  
            o.type=type; o.frequency.value=freq;  
            g.gain.setValueAtTime(vol, this.ctx.currentTime);  
            g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime+dur);  
            o.connect(g); g.connect(this.ctx.destination);  
            o.start(); o.stop(this.ctx.currentTime+dur);  
        },  
        click: function(){ this.play(800,'sine',0.05, 0.05); },  
        win: function(){ this.play(600,'sine',0.1); setTimeout(()=>this.play(1200,'sine',0.3),50); },  
        lose: function(){ this.play(150,'sawtooth',0.3); this.play(100,'sawtooth',0.4); },  
        pop: function(){ this.play(400+Math.random()*200,'triangle',0.05); }  
    };  
    
    // --- PARTICLES ---  
    function boom(x, y, color) {  
        const c = document.getElementById('particles');  
        for(let i=0; i<12; i++) {  
            let p = document.createElement('div');  
            p.className='particle'; p.style.left=x+'px'; p.style.top=y+'px'; p.style.background=color;  
            p.style.boxShadow = `0 0 10px ${color}`;  
            let ang = Math.random()*6.28, vel=Math.random()*100+30;  
            let tx = Math.cos(ang)*vel, ty = Math.sin(ang)*vel;  
            p.animate([{transform:'translate(0,0) scale(1)', opacity:1}, {transform:`translate(${tx}px,${ty}px) scale(0)`, opacity:0}], {duration:600, easing:'ease-out'});  
            c.appendChild(p); setTimeout(()=>p.remove(),600);  
        }  
    }  

    // --- CORE LOGIC ---  
    let game = null, score = 0, diff = 1, timer = null, isPlay = false, countdownTimer = null, rFrameId = null;   
    const scores = { memory:0, math:0, color:0, odd:0, order:0, dash:0, reflex:0, runner:0, glider:0 };  
      
    // Inventory System for 3D Game  
    let inventory = { dust: 0, skin: 0, eggStart: 0 };   

    function loadScores() {  
        try {  
            let s = localStorage.getItem('brainArcadeV6');  
            if(s) Object.assign(scores, JSON.parse(s));  
            let inv = localStorage.getItem('ba_inventory');  
            if(inv) Object.assign(inventory, JSON.parse(inv));  
        } catch(e) { localStorage.removeItem('brainArcadeV6'); }  
          
        // Update High Scores UI  
        for(let k in scores) { let e=document.getElementById(`hs-${k}`); if(e) e.innerText=scores[k]; }  
          
        // Check Egg Status  
        checkEggStatus();  
    }  
      
    function saveScore(g, s) {  
        if(s>scores[g]) { scores[g]=s; localStorage.setItem('brainArcadeV6', JSON.stringify(scores)); }  
    }  

    function saveInventory() {  
        localStorage.setItem('ba_inventory', JSON.stringify(inventory));  
    }  

    function checkEggStatus() {  
        const timerEl = document.getElementById('menu-egg-timer');  
        if(inventory.eggStart > 0) {  
            timerEl.style.display = 'block';  
            const now = Date.now();  
            const elapsed = now - inventory.eggStart;  
            const reqTime = 30 * 60 * 1000; // 30 Minutes  
              
            if(elapsed >= reqTime) {  
                timerEl.innerText = "ü•ö READY TO HATCH!";  
                timerEl.style.color = "#00e676";  
                if(document.getElementById('menu').classList.contains('active') && document.getElementById('egg-overlay').style.display !== 'flex') {  
                   document.getElementById('egg-overlay').style.display = 'flex';  
                }  
            } else {  
                const minsLeft = Math.ceil((reqTime - elapsed) / 60000);  
                timerEl.innerText = `ü•ö HATCHING: ${minsLeft < 1 ? '<1' : minsLeft}m`;  
                timerEl.style.color = "#ffd700";  
            }  
        } else {  
            timerEl.style.display = 'none';  
        }  
    }  

    function claimReward() {  
        inventory.eggStart = 0;  
        inventory.skin++; // Unlock next shape  
        saveInventory();  
        document.getElementById('egg-overlay').style.display = 'none';  
        checkEggStatus();  
        Audio.win();  
    }  

    function showMenu() {  
        stop();   
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));  
        document.getElementById('msg-overlay').style.display='none';  
        document.getElementById('hud').style.display='none';  
        document.getElementById('menu').classList.add('active');  
        loadScores();  
    }  

    function startSequence(g) {  
        // If egg ready and clicking glider, hatch it  
        if(g === 'glider' && inventory.eggStart > 0) {  
            const now = Date.now();  
            if(now - inventory.eggStart >= 30 * 60 * 1000) {  
                document.getElementById('egg-overlay').style.display = 'flex';  
                return;  
            }  
        }  

        Audio.init(); Audio.click(); game = g;  
        document.getElementById('menu').classList.remove('active');  
        document.getElementById('msg-overlay').style.display='none';  
          
        let cd = document.getElementById('countdown-overlay'), txt = document.getElementById('countdown-text');  
        cd.style.display='flex';  
        let n = 3; txt.innerText=n;  
          
        clearInterval(countdownTimer);   
        countdownTimer = setInterval(()=>{  
            n--;  
            if(n>0) { txt.innerText=n; Audio.play(400,'square',0.1); }  
            else if(n===0) { txt.innerText="GO"; Audio.play(800,'square',0.3); }  
            else {   
                clearInterval(countdownTimer);   
                cd.style.display='none';   
                runGame();   
            }  
        }, 600);  
    }  

    function runGame() {  
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));  
        document.getElementById(`game-${game}`).classList.add('active');  
        document.getElementById('hud').style.display='flex';  
        score=0; diff=1; updateScore(0); isPlay=true;  
          
        if(game==='memory') initMem();  
        else if(game==='math') initMath();  
        else if(game==='color') initCol();  
        else if(game==='odd') initOdd();  
        else if(game==='order') initOrder();  
        else if(game==='dash') initDash();  
        else if(game==='reflex') initReflex();  
        else if(game==='runner') initRunner();  
        else if(game==='glider') initGlider();  
    }  

    function restartGame() { startSequence(game); }  
    function updateScore(n) { score+=n; document.getElementById('score-display').innerText="SCORE: "+Math.floor(score); }  
      
    function stop() {   
        isPlay=false;   
        clearInterval(timer);  
        clearInterval(countdownTimer);  
        document.getElementById('countdown-overlay').style.display='none';   
        if(rFrameId) { cancelAnimationFrame(rFrameId); rFrameId = null; }  
          
        // Clean 3D  
        if(gFrameId) { cancelAnimationFrame(gFrameId); gFrameId = null; }  
          
        document.removeEventListener('keydown', handleRunnerKey);  
    }  
      
    function gameOver(reason) {  
        if(!isPlay) return;  
        stop(); Audio.lose(); document.body.classList.add('shaking'); setTimeout(()=>document.body.classList.remove('shaking'),400);  
        saveScore(game, Math.floor(score));  
          
        // Show EGG UI if Glider game  
        const eggUi = document.getElementById('egg-ui');  
        if(game === 'glider' && inventory.dust >= 10 && inventory.eggStart === 0) {  
            eggUi.style.display = 'block';  
            document.getElementById('btn-hatch').onclick = () => {  
                inventory.dust -= 10;  
                inventory.eggStart = Date.now();  
                saveInventory();  
                eggUi.style.display = 'none';  
                showMenu(); // Go back to menu to wait  
            }  
        } else {  
            eggUi.style.display = 'none';  
        }  

        document.getElementById('msg-reason').innerText = reason;  
        document.getElementById('final-score').innerText = Math.floor(score);  
        document.getElementById('msg-overlay').style.display='flex';  
    }  

    function setTimer(id, sec, cb) {  
        clearInterval(timer);  
        let el = document.getElementById(id);   
        if(!el) return;  
        el.style.width='100%';  
        let start = performance.now();  
        timer = setInterval(()=>{  
            let left = 1 - (performance.now()-start)/(sec*1000);  
            if(left<=0) { clearInterval(timer); el.style.width='0%'; cb(); }  
            else el.style.width=(left*100)+'%';  
        }, 16);  
    }  

    // --- MINI GAMES ---  
    // MEMORY  
    let memSeq=[], userSeq=[], memGrid=2;  
    function initMem() { memGrid=2; nextMem(); }  
    function nextMem() {  
        if(!isPlay) return; userSeq=[]; memSeq=[];  
        if(diff>3) memGrid=3; if(diff>8) memGrid=4;  
        let c=document.getElementById('grid-container'); c.innerHTML=''; c.style.gridTemplateColumns=`repeat(${memGrid},1fr)`;  
        for(let i=0; i<memGrid*memGrid; i++) { let d=document.createElement('div'); d.className='tile'; d.id='m-'+i; d.onclick=(e)=>clickMem(i,e); c.appendChild(d); }  
        let steps = Math.floor(diff/2)+2;  
        for(let i=0; i<steps; i++) memSeq.push(Math.floor(Math.random()*(memGrid*memGrid)));  
        playMem();  
    }  
    async function playMem() {  
        document.getElementById('grid-container').style.pointerEvents='none';  
        document.getElementById('level-display').innerText="WATCH";  
        await new Promise(r=>setTimeout(r,500));  
        for(let id of memSeq) { if(!isPlay) return; let el=document.getElementById('m-'+id); el.classList.add('lit'); Audio.play(400+(id*50),'sine',0.1); await new Promise(r=>setTimeout(r,400)); el.classList.remove('lit'); await new Promise(r=>setTimeout(r,100)); }  
        if(!isPlay) return; document.getElementById('level-display').innerText="REPEAT"; document.getElementById('grid-container').style.pointerEvents='auto';  
    }  
    function clickMem(i,e) { let el=document.getElementById('m-'+i); el.classList.add('lit'); setTimeout(()=>el.classList.remove('lit'),150); if(i===memSeq[userSeq.length]) { userSeq.push(i); Audio.pop(); boom(e.clientX,e.clientY,'#00f2ea'); if(userSeq.length===memSeq.length) { Audio.win(); updateScore(10*memGrid); diff++; setTimeout(nextMem,800); } } else gameOver("Wrong Pattern"); }  

    // MATH, COLOR, ODD, ORDER, DASH, REFLEX  
    function initMath() { nextMath(); }  
    function nextMath() { if(!isPlay) return; let ops=['+','-','*'], op=ops[Math.floor(Math.random()*3)], m=5+diff*4, n1=Math.floor(Math.random()*m), n2=Math.floor(Math.random()*m), ans; if(op==='-'){ if(n1<n2)[n1,n2]=[n2,n1]; ans=n1-n2; } else if(op==='*'){ n1=Math.floor(n1/3)+1; n2=Math.floor(n2/3)+1; ans=n1*n2; } else { ans=n1+n2; } let q=`${n1} ${op} ${n2}`, fake=ans+(Math.random()<.5?1:-1)*Math.floor(Math.random()*5+1); while(fake===ans) fake=ans+1; document.getElementById('math-problem').innerText=q; let corr=Math.random()<.5, b1=document.getElementById('btn-opt1'), b2=document.getElementById('btn-opt2'); b1.innerText=corr?ans:fake; b1.onclick=(e)=>ansMath(corr,e); b2.innerText=!corr?ans:fake; b2.onclick=(e)=>ansMath(!corr,e); setTimer('math-timer', Math.max(1.2, 5-diff*0.2), ()=>gameOver("Time Up")); }  
    function ansMath(isC,e) { if(isC){ Audio.win(); boom(e.clientX,e.clientY,'#bf00ff'); updateScore(10); diff++; nextMath(); } else gameOver("Wrong Answer"); }  
    const cols=[{n:'RED',h:'#ff4757'},{n:'BLUE',h:'#1e90ff'},{n:'GREEN',h:'#00e676'},{n:'YELLOW',h:'#ffa502'}]; let tgtH;  
    function initCol() { let c=document.getElementById('color-grid'); c.innerHTML=''; cols.forEach(x=>{ let b=document.createElement('button'); b.className='color-btn'; b.style.backgroundColor=x.h; b.innerText=x.n; b.onclick=(e)=>ansCol(x.h,e); c.appendChild(b); }); nextCol(); }  
    function nextCol() { let w=cols[Math.floor(Math.random()*4)], c=cols[Math.floor(Math.random()*4)]; if(Math.random()>.7) c=w; tgtH=c.h; let el=document.getElementById('color-word'); el.innerText=w.n; el.style.color=c.h; setTimer('color-timer', Math.max(1, 4-diff*0.15), ()=>gameOver("Too Slow")); }  
    function ansCol(h,e) { if(h===tgtH){ Audio.win(); boom(e.clientX,e.clientY,h); updateScore(20); diff++; nextCol(); } else gameOver("Wrong Color"); }  
    const pairs=[['E','F'],['O','0'],['B','8'],['M','W'],['5','S']];  
    function initOdd() { nextOdd(); }  
    function nextOdd() { let gs=Math.min(6, 3+Math.floor(diff/3)), c=document.getElementById('odd-grid'); c.innerHTML=''; c.style.gridTemplateColumns=`repeat(${gs},1fr)`; let p=pairs[Math.floor(Math.random()*pairs.length)], m=p[0], o=p[1], idx=Math.floor(Math.random()*(gs*gs)); if(Math.random()>.5) [m,o]=[o,m]; for(let i=0; i<gs*gs; i++) { let d=document.createElement('div'); d.className='odd-tile'; d.innerText=i===idx?o:m; d.onclick=(e)=>{ if(i===idx){ Audio.win(); boom(e.clientX,e.clientY,'#fff'); updateScore(50); diff++; nextOdd(); } else gameOver("Wrong One"); }; c.appendChild(d); } setTimer('odd-timer', Math.max(2, 6-diff*0.3), ()=>gameOver("Time Up")); }  
    let nN=1, mN=5;  
    function initOrder() { setTimeout(nextOrd, 50); }  
    function nextOrd() { if(!isPlay) return; nN=1; mN=4+Math.floor(diff/2); document.getElementById('next-num').innerText=1; let c=document.getElementById('order-container'); c.innerHTML=''; let positions = [], cW = c.clientWidth || 300, cH = c.clientHeight || 300; for(let i=1; i<=mN; i++) { let b=document.createElement('div'); b.className='order-bubble'; b.innerText=i; b.style.zIndex=(100-i); let maxTries=100, left, top, safe=false; while(maxTries>0 && !safe) { left=Math.random()*75+5; top=Math.random()*75+5; safe=true; let px=(left/100)*cW, py=(top/100)*cH; for(let pos of positions) { let dist=Math.sqrt(Math.pow(px-(pos.x/100)*cW,2)+Math.pow(py-(pos.y/100)*cH,2)); if(dist<60) { safe=false; break; } } maxTries--; } positions.push({x:left, y:top}); b.style.left=left+'%'; b.style.top=top+'%'; b.onclick=(e)=>{ if(parseInt(b.innerText)===nN){ Audio.pop(); boom(e.clientX,e.clientY,'#4facfe'); b.remove(); nN++; document.getElementById('next-num').innerText=nN; if(nN>mN){ Audio.win(); updateScore(mN*10); diff++; nextOrd(); } } else gameOver("Wrong Order"); }; c.appendChild(b); } setTimer('order-timer', 3+(mN*0.6), ()=>gameOver("Too Slow")); }  
    let curDir, curCol; function initDash() { nextDash(); } function nextDash() { if(!isPlay) return; let dirs=['U','D','L','R'], arr={'U':'‚¨Ü','D':'‚¨á','L':'‚¨Ö','R':'‚û°'}; curDir=dirs[Math.floor(Math.random()*4)]; curCol=Math.random()>.5?'GREEN':'RED'; let el=document.getElementById('dash-arrow'); el.innerText=arr[curDir]; el.style.color=curCol==='GREEN'?'#00e676':'#ff4757'; el.style.textShadow=`0 0 30px ${el.style.color}`; setTimer('dash-timer', Math.max(0.8, 3-diff*0.1), ()=>gameOver("Too Slow")); }  
    function checkDash(d, e) { let cD; if(curCol==='GREEN') cD=curDir; else { if(curDir==='U') cD='D'; if(curDir==='D') cD='U'; if(curDir==='L') cD='R'; if(curDir==='R') cD='L'; } if(d===cD) { Audio.win(); boom(e.clientX,e.clientY,curCol==='GREEN'?'#00e676':'#ff4757'); updateScore(20); diff++; nextDash(); } else gameOver("Wrong Direction"); }  
    let reflexTarget; function initReflex() { let c=document.getElementById('reflex-grid'); c.innerHTML=''; for(let i=0; i<9; i++) { let d=document.createElement('div'); d.className='reflex-tile'; d.id='rx-'+i; d.onclick=(e)=>tapReflex(i, e); c.appendChild(d); } nextReflex(); } function nextReflex() { if(!isPlay) return; document.querySelectorAll('.reflex-tile').forEach(t=>t.className='reflex-tile'); let newT; do { newT=Math.floor(Math.random()*9); } while(newT===reflexTarget); reflexTarget=newT; document.getElementById('rx-'+reflexTarget).classList.add('active-target'); Audio.play(600,'triangle',0.05); setTimer('reflex-timer', Math.max(0.6, 2.0-diff*0.1), ()=>gameOver("Too Slow")); } function tapReflex(i, e) { if(i===reflexTarget) { Audio.pop(); boom(e.clientX,e.clientY,'#ff0080'); updateScore(15); diff++; nextReflex(); } else gameOver("Missed!"); }  

    // RUNNER  
    let rCanvas = document.getElementById("runner-canvas"), rCtx = rCanvas.getContext("2d");  
    let rObstacles=[], rDino={x:50,y:220,w:50,h:50,vy:0,gravity:0.6,jump:-12,grounded:false}, rSpeed=5, nextSpawn=0;  
    function initRunner() { rDino={x:50,y:220,w:50,h:50,vy:0,gravity:0.6,jump:-12,grounded:false}; rObstacles=[]; rSpeed=5; score=0; nextSpawn=0; document.addEventListener('keydown', handleRunnerKey); if(rFrameId) cancelAnimationFrame(rFrameId); runnerLoop(); }  
    function runnerJump(e) { if(e&&e.cancelable)e.preventDefault(); if(game!=='runner'||!isPlay)return; if(rDino.grounded){ rDino.vy=rDino.jump; rDino.grounded=false; Audio.play(200,'sawtooth',0.1); } }  
    function handleRunnerKey(e) { if(game==='runner'&&isPlay&&(e.code==="Space"||e.code==="ArrowUp")) runnerJump(e); }  
    function runnerLoop() {   
        if(!isPlay) return; rCtx.clearRect(0,0,700,300);  
        rDino.y+=rDino.vy; rDino.vy+=rDino.gravity; if(rDino.y>=220){rDino.y=220;rDino.vy=0;rDino.grounded=true;}  
        nextSpawn-=rSpeed; if(nextSpawn<=0){ rObstacles.push({x:800,y:235}); nextSpawn=450+Math.random()*500; }  
        rCtx.fillStyle="#bf00ff"; rCtx.fillRect(0,270,700,5);  
        rCtx.font="45px Arial"; rCtx.fillText("üöÄ",rDino.x,rDino.y+40);  
        rObstacles.forEach((o,i)=>{ o.x-=rSpeed; rCtx.fillText("‚òÑÔ∏è",o.x,o.y+40); if(o.x<-50)rObstacles.splice(i,1); if(rDino.x<o.x+30 && rDino.x+40>o.x && rDino.y<o.y+30 && rDino.y+40>o.y) gameOver("Crashed!"); });  
        score+=0.2; rSpeed=5+Math.floor(score/150); updateScore(0);  
        rFrameId=requestAnimationFrame(runnerLoop);  
    }  
    rCanvas.addEventListener("touchstart", function(e){e.preventDefault();runnerJump(e);}, {passive:false});  

    // --- COSMIC GLIDER 3D ---  
    let gScene, gCam, gRen, gPlayer, gObstacles=[], gStars=[], gFrameId;  
    let gSpeed=0.5, gDust=0;  

    function initGlider() {  
        const container = document.getElementById('glider-canvas-area');  
        if(!gRen) {  
            gScene = new THREE.Scene();  
            gScene.fog = new THREE.FogExp2(0x05050a, 0.04);  
            gCam = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 100);  
            gRen = new THREE.WebGLRenderer({alpha:true, antialias:true});  
            gRen.setSize(window.innerWidth, window.innerHeight);  
            container.appendChild(gRen.domElement);  
            gScene.add(new THREE.AmbientLight(0x404040, 2));  
            const dl = new THREE.DirectionalLight(0xffffff, 1);  
            dl.position.set(0,10,5); gScene.add(dl);  
            const grid = new THREE.GridHelper(200, 40, 0x00f2ea, 0x111122);  
            gScene.add(grid);  
              
            container.addEventListener('mousemove', gMove);  
            container.addEventListener('touchmove', gTouch, {passive:false});  
            window.addEventListener('resize', ()=>{  
                gCam.aspect=window.innerWidth/window.innerHeight;  
                gCam.updateProjectionMatrix();  
                gRen.setSize(window.innerWidth, window.innerHeight);  
            });  
        }  
          
        // Reset Game State  
        gObstacles.forEach(o=>gScene.remove(o)); gObstacles=[];  
        gStars.forEach(s=>gScene.remove(s)); gStars=[];  
        gSpeed = 0.4; gDust = 0;  
        document.getElementById('glider-dust-val').innerText = inventory.dust;  
          
        // Create Player based on unlocked skin  
        if(gPlayer) gScene.remove(gPlayer);  
        const skins = [  
            new THREE.ConeGeometry(0.5,1.5,8),  
            new THREE.BoxGeometry(1,1,1),  
            new THREE.CylinderGeometry(0,0.5,1.5,4),  
            new THREE.TorusKnotGeometry(0.4,0.15,64,8)  
        ];  
        const skinGeo = skins[inventory.skin % skins.length];  
        gPlayer = new THREE.Mesh(skinGeo, new THREE.MeshPhongMaterial({color:0x00f2ea, emissive:0x111122}));  
        gPlayer.position.set(0,1,-2);  
        gPlayer.rotation.x = Math.PI/2;  
        gScene.add(gPlayer);  
          
        if(window.innerWidth < 600) { gCam.position.set(0, 5, 12); gCam.rotation.x = -0.4; }  
        else { gCam.position.set(0, 3, 8); gCam.rotation.x = -0.3; }  

        gliderLoop();  
    }  

    function gMove(e) {  
        // FIX: Added safety check for missing player
        if(!isPlay || !gPlayer) return;  
          
        const limit = window.innerWidth < 600 ? 5 : 8;  
        const x = (e.clientX/window.innerWidth)*2-1;  
        gPlayer.position.x = x * limit;  
        gPlayer.rotation.z = -x * 0.5;  
    }  
    function gTouch(e) { e.preventDefault(); gMove(e.touches[0]); }  

    function gliderLoop() {  
        if(!isPlay) return;  
          
        // Spawning  
        if(Math.random()<0.03) {  
            const obs = new THREE.Mesh(new THREE.BoxGeometry(1.5,1.5,1.5), new THREE.MeshPhongMaterial({color:0xff4757}));  
            obs.position.set((Math.random()*16)-8, 1, -50);  
            gScene.add(obs); gObstacles.push(obs);  
        }  
        if(Math.random()<0.05) {  
            const star = new THREE.Mesh(new THREE.OctahedronGeometry(0.5), new THREE.MeshBasicMaterial({color:0xffff00}));  
            star.position.set((Math.random()*16)-8, 1.5, -50);  
            gScene.add(star); gStars.push(star);  
        }  

        // Move & Collide  
        const pBox = new THREE.Box3().setFromObject(gPlayer);  
          
        for(let i=gObstacles.length-1; i>=0; i--) {  
            let o = gObstacles[i]; o.position.z += gSpeed;  
            if(new THREE.Box3().setFromObject(o).intersectsBox(pBox)) { gameOver("SHIP DESTROYED"); return; }  
            if(o.position.z > 10) { gScene.remove(o); gObstacles.splice(i,1); }  
        }  
          
        for(let i=gStars.length-1; i>=0; i--) {  
            let s = gStars[i]; s.position.z += gSpeed; s.rotation.y += 0.1;  
            if(s.position.distanceTo(gPlayer.position) < 1.5) {  
                gScene.remove(s); gStars.splice(i,1);  
                inventory.dust++;  
                saveInventory();  
                document.getElementById('glider-dust-val').innerText = inventory.dust;  
                Audio.play(1000, 'sine', 0.1);  
            } else if(s.position.z > 10) { gScene.remove(s); gStars.splice(i,1); }  
        }  

        gSpeed += 0.0005;  
        score += 0.5; updateScore(0);  
        gRen.render(gScene, gCam);  
        gFrameId = requestAnimationFrame(gliderLoop);  
    }  

    // --- INSTALL & INIT ---  
    window.addEventListener('load', () => { loadScores(); });  
      
    // Fixed Install Prompt Logic  
    let deferredPrompt;  
    window.addEventListener('beforeinstallprompt', (e) => {   
        e.preventDefault();   
        deferredPrompt = e;   
        if(!localStorage.getItem('brainArcadeInstalled')) {  
            document.getElementById('install-popup').classList.add('show');  
        }  
    });  

    function closeInstallPopup() {   
        document.getElementById('install-popup').classList.remove('show');  
    }  
      
    document.getElementById('btn-install-action').addEventListener('click', async () => {   
        if(deferredPrompt) {   
            deferredPrompt.prompt();   
            const { outcome } = await deferredPrompt.userChoice;  
            if(outcome === 'accepted') localStorage.setItem('brainArcadeInstalled', 'true');  
            deferredPrompt = null;   
            closeInstallPopup();   
        }   
    });
</script>  
</body>  
</html>
