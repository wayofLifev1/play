<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">  
    <title>Brain Arcade v6: Ultimate Edition</title>  
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Poppins:wght@400;600&display=swap" rel="stylesheet">  
    <style>  
        :root {  
            --bg-dark: #05050a;  
            --cyan: #00f2ea;  
            --purple: #bf00ff;  
            --gold: #FFD700;
            --font-head: 'Orbitron', sans-serif;  
            --font-body: 'Poppins', sans-serif;  
        }  
        body { margin: 0; font-family: var(--font-body); background-color: var(--bg-dark); color: #fff; overflow: hidden; height: 100vh; }  

        /* Background Effects */
        .nebula-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100%; z-index: -2; background: radial-gradient(circle at 50% 50%, #1a0b2e, #05050a 80%); }  
        .star-field { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.6; background-image: radial-gradient(2px 2px at 40% 40%, rgba(255,255,255,0.8), transparent); background-size: 300px 300px; animation: drift 60s linear infinite; }  
        @keyframes drift { from { background-position: 0 0; } to { background-position: 0 300px; } }  
        
        /* Animations */
        @keyframes float { 0% {transform:translateY(0px);} 50% {transform:translateY(-10px);} 100% {transform:translateY(0px);} }  
        .float-anim { animation: float 3s ease-in-out infinite; }  

        /* --- ALIVE HEADER ANIMATION --- */
        @keyframes alive-pulse {
            0% { text-shadow: 0 0 10px rgba(191, 0, 255, 0.5); transform: scale(1); letter-spacing: 0px; }
            50% { text-shadow: 0 0 25px var(--cyan), 0 0 40px var(--purple); transform: scale(1.02); letter-spacing: 2px; }
            52% { text-shadow: -2px 0 var(--cyan), 2px 0 var(--purple); transform: translateX(-2px); }
            54% { transform: translateX(2px); }
            100% { text-shadow: 0 0 10px rgba(191, 0, 255, 0.5); transform: scale(1); letter-spacing: 0px; }
        }

        /* Layout */
        #app { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }  
        
        /* Header Area with Egg */
        .header-area { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 10px 0; position: relative; }
        
        h1 { 
            font-family: var(--font-head); 
            font-size: 2.5rem; 
            margin: 0; 
            background: linear-gradient(to right, var(--cyan), var(--purple)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-align: center; 
            animation: alive-pulse 4s infinite; 
            cursor: default;
            user-select: none;
        }  

        /* EGG UI STYLES */
        .egg-slot {
            width: 50px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            position: relative;
        }
        .egg-icon { font-size: 2.5rem; filter: drop-shadow(0 0 10px var(--purple)); transition: transform 0.3s; opacity: 0.5; filter: grayscale(1); }
        .egg-slot:hover .egg-icon { transform: scale(1.1); }
        
        /* States for Egg Icon */
        .egg-locked { opacity: 0.3; filter: grayscale(1); }
        .egg-affordable { opacity: 1; filter: drop-shadow(0 0 10px var(--cyan)); animation: float 2s infinite; cursor: pointer; }
        .egg-incubating { opacity: 1; filter: drop-shadow(0 0 15px var(--purple)); }
        .egg-ready { opacity: 1; filter: drop-shadow(0 0 20px var(--gold)); animation: shake 0.5s infinite; }

        @keyframes shake { 0%{transform:rotate(0deg);} 25%{transform:rotate(5deg);} 75%{transform:rotate(-5deg);} 100%{transform:rotate(0deg);} }

        /* Stardust Counter */
        .dust-wallet {
            position: absolute; top: 10px; right: 20px;
            display: flex; align-items: center; gap: 5px;
            background: rgba(0,0,0,0.6); border: 1px solid var(--gold);
            padding: 5px 12px; border-radius: 20px;
            font-family: var(--font-head); color: var(--gold); font-size: 0.9rem;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        /* Menu Grid */
        .menu-scroll { width: 100%; flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding-bottom: 120px; }  
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(135px, 1fr)); gap: 15px; width: 100%; max-width: 500px; padding: 10px; box-sizing: border-box; }  
        .game-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 16px; text-align: center; cursor: pointer; transition: 0.2s; backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.4); }  
        .game-card:active { transform: scale(0.96); background: rgba(255,255,255,0.12); }  
        .game-card h3 { margin: 0; font-size: 0.9rem; color: var(--cyan); font-family: var(--font-head); }  
        .hs-label { font-size: 0.6rem; color: #aaa; margin-top: 8px; display: block; font-weight: bold; }  
        .hs-val { color: #fff; font-size: 1.1rem; font-weight: bold; font-family: var(--font-head); text-shadow: 0 0 10px rgba(255,255,255,0.3); }  

        /* MENU CARD SKIN INDICATORS */
        .skin-active-gold { border: 2px solid var(--gold) !important; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4) !important; }
        .skin-active-neon { border: 2px solid #00f2ea !important; box-shadow: 0 0 20px rgba(0, 242, 234, 0.4) !important; }

        /* Footer */
        .sticky-footer { position: absolute; bottom: 30px; left: 0; width: 100%; pointer-events: none; z-index: 50; display: flex; justify-content: center; align-items: center; }
        @keyframes zero-g { 0% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(8px, -12px) rotate(3deg); } 50% { transform: translate(0, -20px) rotate(0deg); } 75% { transform: translate(-8px, -12px) rotate(-3deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        .chill-btn { pointer-events: auto; width: 75px; height: 75px; border-radius: 50%; background: rgba(10, 10, 20, 0.85); border: 2px solid var(--cyan); box-shadow: 0 0 30px rgba(0, 242, 234, 0.3), inset 0 0 15px rgba(0, 242, 234, 0.2); color: var(--cyan); font-family: var(--font-head); font-size: 0.75rem; font-weight: 900; text-align: center; line-height: 1.2; letter-spacing: 1px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; backdrop-filter: blur(8px); transition: all 0.3s ease; animation: zero-g 6s ease-in-out infinite; }
        .chill-btn:active { transform: scale(0.9) !important; }

        /* Game Container */
        #game-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #05050a; z-index: 100; display: none; }
        iframe { width: 100%; height: 100%; border: none; }

        /* MODAL FOR EGG */
        #egg-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 200; display: none; align-items: center; justify-content: center;
            flex-direction: column;
        }
        .modal-content {
            background: #111; border: 2px solid var(--purple);
            padding: 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 0 50px rgba(191,0,255,0.3); max-width: 80%;
            animation: float 4s ease-in-out infinite;
        }
        .big-egg { font-size: 5rem; margin-bottom: 20px; display: inline-block; }
        .timer-text { font-family: var(--font-head); font-size: 1.5rem; color: var(--cyan); margin: 10px 0; }
        .hatch-btn {
            background: linear-gradient(45deg, var(--gold), #ff8c00);
            border: none; padding: 15px 30px; color: #000; font-weight: 900;
            font-family: var(--font-head); font-size: 1.2rem; border-radius: 30px;
            cursor: pointer; box-shadow: 0 0 20px var(--gold);
            margin-top: 15px; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
    </style>
</head>  
<body>  
<div id="app">  
    <div class="nebula-bg"></div>  
    <div class="star-field"></div>  
    
    <div class="dust-wallet">
        <span>‚ú®</span>
        <span id="wallet-val">0</span>
    </div>
            
    <div style="width:100%; max-width:500px; margin-top:10px; margin-bottom:15px; padding:0 20px; box-sizing:border-box; text-align: center;">
            <p style="color:#FFD700; font-family:var(--font-head); font-size:0.9rem; margin:0 0 8px 0; text-shadow:0 0 10px rgba(255, 215, 0, 0.5); letter-spacing: 1px;">
                Install üëá apps now
            </p>
            <div style="display:flex; gap:10px;">
                <button id="install-btn" class="float-anim" style="display:none; flex:1; align-items:center; justify-content:center; padding:8px 10px; background: linear-gradient(45deg, #00f2ea, #bf00ff); box-shadow: 0 4px 15px rgba(0, 242, 234, 0.3); border:none; border-radius:20px; color:#fff; font-family:var(--font-head); font-weight: 900; font-size:0.75rem; transition:0.2s; cursor:pointer;">
                    <span style="font-size:1.2rem; margin-right:5px;">‚¨áÔ∏è</span> INSTALL APP
                </button>
                <a href="https://twolife-v1.github.io/my/" target="_blank" rel="noopener noreferrer" class="float-anim" style="flex:1; text-decoration:none; display:flex; align-items:center; justify-content:center; padding:8px 10px; background: linear-gradient(45deg, #FFD700, #FFA500); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); border:none; border-radius:20px; color:#05050a; font-family:var(--font-head); font-weight: 900; font-size:0.75rem; transition:0.2s;">
                   <img src="icon-512.png" style="height:24px; width:24px; margin-right:8px; border-radius:5px; vertical-align:middle;"> WaktuSolat
                </a>
                <a href="https://pipahcookiesapp.github.io/com/" target="_blank" rel="noopener noreferrer" class="float-anim" style="flex:1; text-decoration:none; display:flex; align-items:center; justify-content:center; padding:8px 10px; background: linear-gradient(45deg, #FFD700, #FFA500); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); border:none; border-radius:20px; color:#05050a; font-family:var(--font-head); font-weight: 900; font-size:0.75rem; transition:0.2s; animation-delay:0.3s;">
                   <img src="icon.png" style="height:24px; width:24px; margin-right:8px; border-radius:5px; vertical-align:middle;"> PipahCookies
                </a>
            </div>
    </div>

    <div class="header-area">
        <h1>BRAIN<br>ARCADE</h1>  
        <div class="egg-slot" onclick="openEggUI()">
            <div class="egg-icon" id="main-egg-icon">ü•ö</div>
        </div>
    </div>
    
    <div style="text-align:center; margin-bottom:10px;">
        <button onclick="openWardrobe()" style="background:transparent; border:1px solid var(--cyan); color:var(--cyan); padding:5px 15px; border-radius:15px; font-family:var(--font-head); cursor:pointer; transition:0.2s;">üëï SKINS</button>
    </div>

    <p style="text-align:center; opacity: 0.6; font-size: 0.9rem; margin: 0; letter-spacing: 3px; color:var(--cyan); margin-bottom: 10px;">PLATFORM HUB</p>  

    <div class="menu-scroll">  
        <div class="menu-grid">  
            <div id="card-cosmic" class="game-card float-anim" onclick="launchGame('cosmic.html', 'cosmic')" style="border-top: 3px solid #ff00ff; box-shadow: 0 0 20px rgba(255,0,255,0.3); grid-column: span 2;">  
                <h3 style="color:#ff00ff; font-size: 1.2rem;">COSMIC GLIDE 3D</h3>  
                <span class="hs-label">HIGH SCORE</span><span id="hs-glider" class="hs-val">0</span>  
            </div>  
            
            <div id="card-memory" class="game-card float-anim" onclick="launchGame('arcade.html?game=memory', 'arcade')" style="border-top: 3px solid #4facfe; animation-delay: 0.1s;">  
                <h3>MEMORY MATRIX</h3> <span class="hs-label">BEST</span><span id="hs-memory" class="hs-val">0</span>  
            </div>  
            <div id="card-math" class="game-card float-anim" onclick="launchGame('arcade.html?game=math', 'arcade')" style="border-top: 3px solid #bf00ff; animation-delay: 0.2s;">  
                <h3>QUICK MATH</h3> <span class="hs-label">BEST</span><span id="hs-math" class="hs-val">0</span>  
            </div>  
            <div id="card-color" class="game-card float-anim" onclick="launchGame('arcade.html?game=color', 'arcade')" style="border-top: 3px solid #f1c40f; animation-delay: 0.3s;">  
                <h3>COLOR TRAP</h3> <span class="hs-label">BEST</span><span id="hs-color" class="hs-val">0</span>  
            </div>  
            <div id="card-odd" class="game-card float-anim" onclick="launchGame('arcade.html?game=odd', 'arcade')" style="border-top: 3px solid #fff; animation-delay: 0.4s;">  
                <h3>ODD ONE OUT</h3> <span class="hs-label">BEST</span><span id="hs-odd" class="hs-val">0</span>  
            </div>  
            <div id="card-order" class="game-card float-anim" onclick="launchGame('arcade.html?game=order', 'arcade')" style="border-top: 3px solid #4facfe; animation-delay: 0.5s;">  
                <h3>ORDER CHAOS</h3> <span class="hs-label">BEST</span><span id="hs-order" class="hs-val">0</span>  
            </div>  
            <div id="card-dash" class="game-card float-anim" onclick="launchGame('arcade.html?game=dash', 'arcade')" style="border-top: 3px solid #00e676; animation-delay: 0.6s;">  
                <h3>DIRECTION DASH</h3> <span class="hs-label">BEST</span><span id="hs-dash" class="hs-val">0</span>  
            </div>  
            <div id="card-reflex" class="game-card float-anim" onclick="launchGame('arcade.html?game=reflex', 'arcade')" style="border-top: 3px solid #ff0080; animation-delay: 0.7s;">  
                <h3>RAPID REFLEX</h3> <span class="hs-label">BEST</span><span id="hs-reflex" class="hs-val">0</span>  
            </div>  
            <div id="card-runner" class="game-card float-anim" onclick="launchGame('arcade.html?game=runner', 'arcade')" style="border-top: 3px solid #bf00ff; animation-delay: 0.8s;">  
                <h3>ROCKET RUN</h3> <span class="hs-label">BEST</span><span id="hs-runner" class="hs-val">0</span>  
            </div>  
        </div>  
    </div>  

    <div class="sticky-footer">
        <div class="chill-btn" onclick="launchInternalChill()" title="Chill Mode">
            GET<br>CALM
        </div>
    </div>

    <div id="egg-modal" onclick="closeEggUI(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 style="font-family:var(--font-head); color:var(--purple); margin-top:0;">MYSTERY EGG</h2>
            <div class="big-egg" id="modal-egg-visual">ü•ö</div>
            
            <div id="view-locked" style="display:none;">
                <p>YOU NEED 10 STARDUST</p>
                <p style="font-size:0.8rem; color:#aaa;">Play Cosmic or Arcade.<br>Collect Stardust ‚ú®</p>
                <p style="color:var(--gold);">Balance: <span id="modal-bal-locked">0</span>/10</p>
            </div>

            <div id="view-buy" style="display:none;">
                <p style="color:var(--cyan);">STARDUST COLLECTED!</p>
                <p style="font-size:0.8rem; color:#aaa;">Exchange 10 Stardust to incubate?</p>
                <button class="hatch-btn" onclick="buyEgg()">INCUBATE (10 ‚ú®)</button>
            </div>

            <div id="view-incubating" style="display:none;">
                <p>INCUBATING...</p>
                <div class="timer-text" id="egg-timer">00:00:00</div>
                <p style="font-size:0.8rem; color:#aaa;">Patience is key.</p>
            </div>

            <div id="view-ready" style="display:none;">
                <p style="color:var(--gold);">READY TO HATCH!</p>
                <button class="hatch-btn" onclick="hatchEgg()">HATCH NOW</button>
            </div>
            
             <div id="view-reward" style="display:none;">
                <p style="color:var(--gold); font-size:1.5rem;">SKIN UNLOCKED!</p>
                <p id="reward-game-name" style="font-size:0.8rem; color:#fff; margin:0;">GAME</p>
                <p id="reward-skin-name" style="font-family:var(--font-head); color:var(--cyan); font-size: 1.2rem; margin-top:5px;">SKIN NAME</p>
                <button class="hatch-btn" style="background:#333; color:#fff; font-size:1rem;" onclick="closeEggUI(null)">EQUIP NOW</button>
            </div>
        </div>
    </div>

    <div id="wardrobe-modal" onclick="closeWardrobe(event)" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; align-items:center; justify-content:center;">
        <div class="modal-content" onclick="event.stopPropagation()" style="width:80%; max-width:400px; max-height:70vh; overflow-y:auto;">
            <h2 style="font-family:var(--font-head); color:var(--cyan);">SKIN COLLECTION</h2>
            <div id="skin-list" style="text-align:left; margin-top:20px;"></div>
            <button class="hatch-btn" onclick="closeWardrobe({target:{id:'wardrobe-modal'}})" style="margin-top:20px; font-size:1rem; padding:10px 20px;">CLOSE</button>
        </div>
    </div>

    <div id="game-layer">
        <iframe id="game-frame" src=""></iframe>
    </div>
</div>  

<script>
    // --- 1. INTERNAL CHILL GAME SOURCE ---
    const chillGameCode = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Poppins:wght@400&display=swap" rel="stylesheet">
        <style>
            body { margin: 0; background: radial-gradient(circle at 50% 50%, #1a0b2e, #05050a 80%); font-family: 'Orbitron', sans-serif; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; user-select: none; -webkit-tap-highlight-color: transparent; }
            .back-btn { position:absolute; top:20px; left:20px; background: rgba(0,0,0,0.5); border: 1px solid #00f2ea; color: #00f2ea; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; backdrop-filter: blur(5px); z-index:100; }
            #instruction { font-size: 1.8rem; letter-spacing: 2px; text-shadow: 0 0 10px #00f2ea; margin-bottom: 40px; text-align: center; color: #00f2ea; }
            #breathing-circle { width: 160px; height: 160px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 4px solid rgba(0, 242, 234, 0.4); display: flex; justify-content: center; align-items: center; box-shadow: 0 0 30px rgba(0, 242, 234, 0.1); cursor: pointer; transition: transform 0.05s linear; }
            .pulse { animation: p 2s infinite; }
            @keyframes p { 0% {transform:scale(1); border-color: rgba(0,242,234,0.4);} 50% {transform:scale(1.05); border-color: rgba(191,0,255,0.8);} 100% {transform:scale(1); border-color: rgba(0,242,234,0.4);} }
            #center-icon { font-size: 5rem; pointer-events: none; }
            #progress-bar { position: absolute; bottom: 80px; width: 60%; height: 6px; background: #111; border-radius: 10px; overflow: hidden; border: 1px solid #333; }
            #fill { width: 0%; height: 100%; background: linear-gradient(90deg, #00f2ea, #bf00ff); box-shadow: 0 0 10px #00f2ea; transition: width 0.5s; }
        </style>
    </head>
    <body>
        <div class="back-btn" onclick="window.parent.postMessage('close_game', '*')">‚úï</div>
        <div id="instruction">HOLD TO CHARGE</div>
        <div id="breathing-circle" class="pulse"><div id="center-icon">‚öõÔ∏è</div></div>
        <div id="progress-bar"><div id="fill"></div></div>
        <script>
            let scale=1, progress=0, isHolding=false;
            const circle = document.getElementById('breathing-circle');
            const txt = document.getElementById('instruction');
            const fill = document.getElementById('fill');
            
            function loop() {
                if(isHolding) { if(scale<2.5) scale+=0.01; } else { if(scale>1) scale-=0.02; else scale=1; }
                circle.style.transform = 'scale('+scale+')';
                requestAnimationFrame(loop);
            }
            loop();
            circle.addEventListener('mousedown', () => { isHolding=true; circle.classList.remove('pulse'); txt.innerText="INHALE..."; });
            circle.addEventListener('touchstart', (e) => { e.preventDefault(); isHolding=true; circle.classList.remove('pulse'); txt.innerText="INHALE..."; });
            window.addEventListener('mouseup', end);
            window.addEventListener('touchend', end);
            function end() { 
                if(!isHolding) return;
                isHolding=false; txt.innerText="EXHALE...";
                if(scale>2.0) { progress+=20; fill.style.width=progress+'%'; if(progress>=100) { txt.innerText="RESTORED"; document.getElementById('center-icon').innerText="üí†"; } }
                else setTimeout(()=>{ if(!isHolding) txt.innerText="HOLD TO CHARGE"; }, 1000);
            }
        <\/script>
    </body>
    </html>`;

    function launchInternalChill() {
        const frame = document.getElementById('game-frame');
        const blob = new Blob([chillGameCode], { type: 'text/html' });
        frame.src = URL.createObjectURL(blob);
        document.getElementById('game-layer').style.display = 'block';
    }

    // --- PWA INSTALL LOGIC ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = document.getElementById('install-btn');
        if(btn) {
            btn.style.display = 'flex';
            btn.addEventListener('click', () => {
                btn.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt = null;
            });
        }
    });

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});

    // --- APP LOGIC ---
    // DATA STRUCTURE
    const appData = { 
        scores: { memory:0, math:0, color:0, odd:0, order:0, dash:0, reflex:0, runner:0, glider:0 },
        stardust: 0, 
        egg: { active: false, hatchTime: 0, ready: false },
        unlockedSkins: [], 
        activeSkins: { cosmic: 'default', arcade: 'default' } 
    };  
    
    const rewardPool = [
        { id: 'cosmic_gold', game: 'cosmic', name: 'Golden Starship', skinId: 'gold' },
        { id: 'cosmic_neon', game: 'cosmic', name: 'Neon Glitch', skinId: 'neon' },
        { id: 'arcade_gold', game: 'arcade', name: 'Midas Touch UI', skinId: 'gold' },
        { id: 'arcade_neon', game: 'arcade', name: 'Cyberpunk UI', skinId: 'neon' }
    ];

    function saveData() { localStorage.setItem('brainArcadeV6_Data', JSON.stringify(appData)); updateUI(); }

    function loadData() {  
        try {  
            let s = localStorage.getItem('brainArcadeV6_Data');  
            if(s) Object.assign(appData, JSON.parse(s));  
        } catch(e) {}  
        updateUI();
    }  

    function updateUI() {
        // Update Scores
        for(let k in appData.scores) { 
            let e=document.getElementById(`hs-${k}`); 
            if(e) e.innerText=appData.scores[k]; 
        } 
        // Update Wallet
        document.getElementById('wallet-val').innerText = appData.stardust;
        
        // Update Egg Status Icon
        const icon = document.getElementById('main-egg-icon');
        const now = Date.now();
        
        // Reset Logic
        icon.className = 'egg-icon';
        
        if(appData.egg.active) {
            // Egg Exists
            if(now >= appData.egg.hatchTime) {
                icon.classList.add('egg-ready');
            } else {
                icon.classList.add('egg-incubating');
            }
        } else {
            // No Egg
            if(appData.stardust >= 10) {
                icon.classList.add('egg-affordable');
            } else {
                icon.classList.add('egg-locked');
            }
        }
        updateMenuVisuals();
    }

    function updateMenuVisuals() {
        // Reset all borders first
        document.querySelectorAll('.game-card').forEach(el => el.classList.remove('skin-active-gold', 'skin-active-neon'));
        
        // Apply Cosmic Skin
        const cosmicCard = document.getElementById('card-cosmic');
        if(appData.activeSkins.cosmic === 'gold') cosmicCard.classList.add('skin-active-gold');
        if(appData.activeSkins.cosmic === 'neon') cosmicCard.classList.add('skin-active-neon');

        // Apply Arcade Skin (to all arcade games)
        const arcadeCards = ['card-memory', 'card-math', 'card-color', 'card-odd', 'card-order', 'card-dash', 'card-reflex', 'card-runner'];
        arcadeCards.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                if(appData.activeSkins.arcade === 'gold') el.classList.add('skin-active-gold');
                if(appData.activeSkins.arcade === 'neon') el.classList.add('skin-active-neon');
            }
        });
    }

    // --- WARDROBE LOGIC ---
    function openWardrobe() {
        const list = document.getElementById('skin-list');
        list.innerHTML = '';
        
        // 1. Default Option
        list.innerHTML += `<div style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
            <div style="color:#fff; font-weight:bold;">DEFAULT SYSTEM</div>
            <button onclick="equipSkin('cosmic','default')" style="margin:5px; padding:5px 10px; background:${appData.activeSkins.cosmic=='default'?'var(--cyan)':'#333'}; border:none; color:#fff;">Cosmic</button>
            <button onclick="equipSkin('arcade','default')" style="margin:5px; padding:5px 10px; background:${appData.activeSkins.arcade=='default'?'var(--cyan)':'#333'}; border:none; color:#fff;">Arcade</button>
        </div>`;

        // 2. Unlocked Options
        if(appData.unlockedSkins.length === 0) {
            list.innerHTML += `<div style="color:#aaa; font-style:italic;">No skins unlocked yet. Hatch eggs!</div>`;
        } else {
            appData.unlockedSkins.forEach(id => {
                const skin = rewardPool.find(r => r.id === id);
                if(skin) {
                    const isActive = appData.activeSkins[skin.game] === skin.skinId;
                    list.innerHTML += `
                    <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:${skin.skinId==='gold'?'#FFD700':'#ff00ff'}">${skin.name}</span>
                        <button onclick="equipSkin('${skin.game}', '${skin.skinId}')" 
                            style="background:${isActive ? 'var(--cyan)' : '#333'}; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">
                            ${isActive ? 'EQUIPPED' : 'EQUIP'}
                        </button>
                    </div>`;
                }
            });
        }
        document.getElementById('wardrobe-modal').style.display = 'flex';
    }

    function equipSkin(game, skinId) {
        appData.activeSkins[game] = skinId;
        saveData();
        openWardrobe(); // Refresh UI
    }

    function closeWardrobe(e) {
        if(e.target.id === 'wardrobe-modal') document.getElementById('wardrobe-modal').style.display = 'none';
    }

    // --- EGG BUYING LOGIC ---

    function buyEgg() {
        if(appData.stardust < 10) return;
        
        // Deduct Cost
        appData.stardust -= 10;
        
        // Init Egg
        appData.egg.active = true;
        // 60 Second Timer (Fixed as per request)
        appData.egg.hatchTime = Date.now() + (60 * 1000); 
        appData.egg.ready = false;
        
        saveData();
        openEggUI(); // Refresh UI to Incubating View
    }

    let eggTimerInterval;

    function openEggUI() {
        const modal = document.getElementById('egg-modal');
        const now = Date.now();
        
        // Hide all views first
        ['view-locked', 'view-buy', 'view-incubating', 'view-ready', 'view-reward'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });

        document.getElementById('modal-egg-visual').style.transform = 'scale(1)';
        document.getElementById('modal-egg-visual').innerText = 'ü•ö';

        modal.style.display = 'flex';

        if (appData.egg.active) {
            // Egg exists
            if (now < appData.egg.hatchTime) {
                document.getElementById('view-incubating').style.display = 'block';
                startTimer();
            } else {
                document.getElementById('view-ready').style.display = 'block';
            }
        } else {
            // No egg - Check Wallet
            if (appData.stardust >= 10) {
                document.getElementById('view-buy').style.display = 'block';
            } else {
                document.getElementById('view-locked').style.display = 'block';
                document.getElementById('modal-bal-locked').innerText = appData.stardust;
            }
        }
    }

    function startTimer() {
        const timerEl = document.getElementById('egg-timer');
        clearInterval(eggTimerInterval);
        eggTimerInterval = setInterval(() => {
            const diff = appData.egg.hatchTime - Date.now();
            if (diff <= 0) {
                clearInterval(eggTimerInterval);
                openEggUI(); 
                updateUI();
                return;
            }
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            timerEl.innerText = `${h}h ${m}m ${s}s`;
        }, 1000);
    }

    function hatchEgg() {
        const unowned = rewardPool.filter(r => !appData.unlockedSkins.includes(r.id));
        let reward;
        
        if(unowned.length === 0) reward = rewardPool[Math.floor(Math.random() * rewardPool.length)];
        else reward = unowned[Math.floor(Math.random() * unowned.length)];
        
        if(!appData.unlockedSkins.includes(reward.id)) appData.unlockedSkins.push(reward.id);

        appData.activeSkins[reward.game] = reward.skinId;

        // Reset Egg
        appData.egg.active = false;
        appData.egg.ready = false;
        saveData();
        updateUI();

        // Animation
        const eggVis = document.getElementById('modal-egg-visual');
        eggVis.style.transition = '0.5s';
        eggVis.style.transform = 'scale(1.5) rotate(10deg)';
        setTimeout(() => {
            eggVis.innerText = 'üí•';
            setTimeout(() => {
                eggVis.innerText = 'üéÅ';
                document.getElementById('view-ready').style.display = 'none';
                document.getElementById('view-reward').style.display = 'block';
                document.getElementById('reward-game-name').innerText = (reward.game === 'cosmic' ? 'COSMIC GLIDE' : 'ARCADE SUITE');
                document.getElementById('reward-skin-name').innerText = reward.name;
            }, 300);
        }, 300);
    }

    function closeEggUI(e) {
        if(e && e.target.id !== 'egg-modal') return; 
        document.getElementById('egg-modal').style.display = 'none';
        clearInterval(eggTimerInterval);
    }

    // --- GAME LAUNCHER & COMMUNICATION ---
    function launchGame(url, category) {
        const layer = document.getElementById('game-layer');
        const frame = document.getElementById('game-frame');
        
        let skinParam = '';
        if (category && appData.activeSkins[category] !== 'default') {
            const separator = url.includes('?') ? '&' : '?';
            skinParam = `${separator}skin=${appData.activeSkins[category]}`;
        }
        frame.src = url + skinParam;
        layer.style.display = 'block';
    }

    window.addEventListener('message', function(event) {
        if(event.data === 'close_game') {
            document.getElementById('game-layer').style.display = 'none';
            document.getElementById('game-frame').src = '';
            setTimeout(loadData, 50); 
        }
        // HANDLE STARDUST
        if(event.data && event.data.type === 'stardust_collected') {
            appData.stardust++;
            saveData();
            // Show Notification
            const notif = document.createElement('div');
            notif.innerHTML = "‚ú® +1 STARDUST";
            notif.style.cssText = "position:fixed; top:50px; right:20px; background:rgba(0,0,0,0.8); color:#ffd700; border:1px solid #ffd700; padding:5px 10px; border-radius:20px; font-weight:bold; font-family:var(--font-head); animation:float 1s ease-out forwards; z-index:9999;";
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 1000);
        }
        // HIGH SCORE RECEIVED (Fix for saving scores)
        if(event.data && event.data.type === 'game_over') {
            const gameName = event.data.game; // e.g., 'runner', 'memory'
            const score = event.data.score;
            
            // Update if higher
            if(!appData.scores[gameName] || score > appData.scores[gameName]) {
                appData.scores[gameName] = Math.floor(score);
                saveData(); // Saves to localStorage 'brainArcadeV6_Data'
                console.log("New Highscore Saved:", gameName, score);
            }
        }
    });

    loadData();
</script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
    // FIREBASE ANALYTICS & PRESENCE SYSTEM
    const firebaseConfig = { apiKey: "AIzaSyCYPD6eFQvtwi6CMBkAbQ1SmkWA2qtby9s", authDomain: "wofplay-123.firebaseapp.com", databaseURL: "https://wofplay-123-default-rtdb.firebaseio.com", projectId: "wofplay-123", storageBucket: "wofplay-123.firebasestorage.app", messagingSenderId: "716443688368", appId: "1:716443688368:web:6ebd08d8d3a49f1c494a75" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // User ID generation
    let uid = localStorage.getItem('ba_uid');
    if (!uid) { uid = 'user_' + Math.floor(Math.random() * 100000); localStorage.setItem('ba_uid', uid); db.ref('stats/installs').transaction(c => (c || 0) + 1); }
    
    // Track Visits
    db.ref('stats/visits').transaction(current => (current || 0) + 1);

    // --- ONLINE PRESENCE SYSTEM (NEW) ---
    // This tells Firebase "I am here" and auto-removes the entry when "I leave"
    const connectedRef = db.ref(".info/connected");
    const userStatusDatabaseRef = db.ref("status/" + uid);

    connectedRef.on("value", (snap) => {
        if (snap.val() === true) {
            // If we lose connection, remove this user from the list
            userStatusDatabaseRef.onDisconnect().remove().then(() => {
                // Determine device type roughly
                const deviceType = /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop';
                
                // Add user to the online list
                userStatusDatabaseRef.set({
                    state: 'online',
                    last_changed: firebase.database.ServerValue.TIMESTAMP,
                    device: deviceType
                });
            });
        }
    });
</script> 
</body>  
</html>
